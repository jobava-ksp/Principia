
// .\Release\benchmarks.exe  --benchmark_repetitions=3 --benchmark_filter=Ephemeris                                                                     // NOLINT(whitespace/line_length)
// Benchmarking on 1 X 3310 MHz CPU
// 2015/06/07-19:13:02
// Benchmark                                              Time(ns)    CPU(ns) Iterations                                                                // NOLINT(whitespace/line_length)
// -------------------------------------------------------------------------------------                                                                // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMajorBodiesOnly               32262829042 32042605400          1                                 +1.00027592626789170e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMajorBodiesOnly               32159141040 31980205000          1                                 +1.00027592626789170e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMajorBodiesOnly               32102733827 31886604400          1                                 +1.00027592626789170e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMajorBodiesOnly_mean          32174901303 31969804933          1                                 +1.00027592626789170e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMajorBodiesOnly_stddev           66301880    64110317          0                                 +1.00027592626789170e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMinorAndMajorBodies           64563697791 64007210300          1                                 +1.00027592631378660e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMinorAndMajorBodies           63800743318 63554807400          1                                 +1.00027592631378660e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMinorAndMajorBodies           63677407003 63445606700          1                                 +1.00027592631378660e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMinorAndMajorBodies_mean      64013949371 63669208133          1                                 +1.00027592631378660e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemMinorAndMajorBodies_stddev      391978278   243125889          0                                 +1.00027592631378660e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemAllBodiesAndOblateness        72713847613 72462464500          1                                 +1.00027592630007800e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemAllBodiesAndOblateness        72730153299 72446864400          1                                 +1.00027592630007800e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemAllBodiesAndOblateness        72495137429 72150462500          1                                 +1.00027592630007800e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemAllBodiesAndOblateness_mean   72646379447 72353263800          1                                 +1.00027592630007800e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisSolarSystemAllBodiesAndOblateness_stddev   107151232   143543527          0                                 +1.00027592630007800e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMajorBodiesOnly                   2180058694 2184014000          1                                 154379 steps, +9.99375002672519890e-01 ua, +1.09612948155357200e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMajorBodiesOnly                   2201188541 2199614100          1                                 154379 steps, +9.99375002672519890e-01 ua, +1.09612948155357200e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMajorBodiesOnly                   2175151324 2152813800          1                                 154379 steps, +9.99375002672519890e-01 ua, +1.09612948155357200e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMajorBodiesOnly_mean              2185466186 2178813967          1                                 154379 steps, +9.99375002672519890e-01 ua, +1.09612948155357200e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMajorBodiesOnly_stddev              11296456   19456743          0                                 154379 steps, +9.99375002672519890e-01 ua, +1.09612948155357200e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMinorAndMajorBodies               3570523477 3541222700          1                                 154379 steps, +9.99375002971591540e-01 ua, +1.09612948399728950e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMinorAndMajorBodies               3555268979 3541222700          1                                 154379 steps, +9.99375002971591540e-01 ua, +1.09612948399728950e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMinorAndMajorBodies               3584791637 3556822800          1                                 154379 steps, +9.99375002971591540e-01 ua, +1.09612948399728950e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMinorAndMajorBodies_mean          3570194698 3546422733          1                                 154379 steps, +9.99375002971591540e-01 ua, +1.09612948399728950e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeMinorAndMajorBodies_stddev          12054816    7353958          0                                 154379 steps, +9.99375002971591540e-01 ua, +1.09612948399728950e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeAllBodiesAndOblateness            3592815375 3572422900          1                                 154379 steps, +9.99375002831796140e-01 ua, +1.09612948296100400e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeAllBodiesAndOblateness            3576630569 3572422900          1                                 154379 steps, +9.99375002831796140e-01 ua, +1.09612948296100400e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeAllBodiesAndOblateness            3606213784 3572422900          1                                 154379 steps, +9.99375002831796140e-01 ua, +1.09612948296100400e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeAllBodiesAndOblateness_mean       3591886576 3572422900          1                                 154379 steps, +9.99375002831796140e-01 ua, +1.09612948296100400e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisL4ProbeAllBodiesAndOblateness_stddev       12095141          0          0                                 154379 steps, +9.99375002831796140e-01 ua, +1.09612948296100400e+00 ua  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMajorBodiesOnly                10688688970 10561267700          1                                 750001 steps, +9.99958256175519030e-01 ua, +9.99467610064657630e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMajorBodiesOnly                10569486118 10576867800          1                                 750001 steps, +9.99958256175519030e-01 ua, +9.99467610064657630e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMajorBodiesOnly                10597834802 10498867300          1                                 750001 steps, +9.99958256175519030e-01 ua, +9.99467610064657630e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMajorBodiesOnly_mean           10618669963 10545667600          1                                 750001 steps, +9.99958256175519030e-01 ua, +9.99467610064657630e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMajorBodiesOnly_stddev            50845570    33700068          0                                 750001 steps, +9.99958256175519030e-01 ua, +9.99467610064657630e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMinorAndMajorBodies            17136606432 16957308700          1                                 750001 steps, +9.99958201625830930e-01 ua, +9.99467157003521010e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMinorAndMajorBodies            17104295946 16957308700          1                                 750001 steps, +9.99958201625830930e-01 ua, +9.99467157003521010e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMinorAndMajorBodies            17051381088 17004109000          1                                 750001 steps, +9.99958201625830930e-01 ua, +9.99467157003521010e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMinorAndMajorBodies_mean       17097427822 16972908800          1                                 750001 steps, +9.99958201625830930e-01 ua, +9.99467157003521010e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeMinorAndMajorBodies_stddev        35130406    22061873          0                                 750001 steps, +9.99958201625830930e-01 ua, +9.99467157003521010e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeAllBodiesAndOblateness         17494721866 17206910300          1                                 750001 steps, +9.99958313425507670e-01 ua, +9.99469266237663870e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeAllBodiesAndOblateness         17647014833 17128909800          1                                 750001 steps, +9.99958313425507670e-01 ua, +9.99469266237663870e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeAllBodiesAndOblateness         17464009262 17253710600          1                                 750001 steps, +9.99958313425507670e-01 ua, +9.99469266237663870e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeAllBodiesAndOblateness_mean    17535248654 17196510233          1                                 750001 steps, +9.99958313425507670e-01 ua, +9.99469266237663870e+01 nmi  // NOLINT(whitespace/line_length)
// BM_EphemerisLEOProbeAllBodiesAndOblateness_stddev     80019061    51477704          0                                 750001 steps, +9.99958313425507670e-01 ua, +9.99469266237663870e+01 nmi  // NOLINT(whitespace/line_length)

#include <memory>
#include <vector>

#include "base/not_null.hpp"
#include "geometry/named_quantities.hpp"
#include "geometry/quaternion.hpp"
#include "geometry/rotation.hpp"
#include "integrators/embedded_explicit_runge_kutta_nyström_integrator.hpp"
#include "integrators/symplectic_runge_kutta_nyström_integrator.hpp"
#include "physics/ephemeris.hpp"
#include "physics/massless_body.hpp"
#include "quantities/astronomy.hpp"
#include "quantities/bipm.hpp"
#include "quantities/elementary_functions.hpp"
#include "quantities/numbers.hpp"
#include "quantities/quantities.hpp"
#include "quantities/si.hpp"
#include "testing_utilities/solar_system.hpp"

// Must come last to avoid conflicts when defining the CHECK macros.
#include "benchmark/benchmark.h"

namespace principia {

using astronomy::JulianYear;
using base::not_null;
using bipm::NauticalMile;
using geometry::Position;
using geometry::Quaternion;
using geometry::Rotation;
using integrators::DormandElMikkawyPrince1986RKN434FM;
using integrators::McLachlanAtela1992Order5Optimal;
using physics::Ephemeris;
using physics::MasslessBody;
using quantities::DebugString;
using quantities::Sqrt;
using si::AstronomicalUnit;
using si::Metre;
using si::Milli;
using si::Minute;
using testing_utilities::ICRFJ2000Ecliptic;
using testing_utilities::SolarSystem;

namespace benchmarks {

namespace {

void EphemerisSolarSystemBenchmark(SolarSystem::Accuracy const accuracy,
                                   not_null<benchmark::State*> const state) {
  Length error;
  while (state->KeepRunning()) {
    state->PauseTiming();
    not_null<std::unique_ptr<SolarSystem>> const at_спутник_1_launch =
        SolarSystem::AtСпутник1Launch(accuracy);
    std::vector<not_null<std::unique_ptr<MassiveBody const>>> bodies =
        at_спутник_1_launch->massive_bodies();
    std::vector<DegreesOfFreedom<ICRFJ2000Ecliptic>> const initial_state =
        at_спутник_1_launch->initial_state();

    Instant const initial_time = at_спутник_1_launch->time();
    Instant const final_time = initial_time + 100 * JulianYear;

    Ephemeris<ICRFJ2000Ecliptic>
        ephemeris(
            std::move(bodies),
            initial_state,
            at_спутник_1_launch->time(),
            McLachlanAtela1992Order5Optimal<Position<ICRFJ2000Ecliptic>>(),
            45 * Minute,
            0.1 * Milli(Metre),
            5 * Milli(Metre));

    state->ResumeTiming();
    ephemeris.Prolong(final_time);
    state->PauseTiming();
    error = (ephemeris.trajectory(ephemeris.bodies()[SolarSystem::kSun]).
                 EvaluatePosition(final_time, nullptr) -
             ephemeris.trajectory(ephemeris.bodies()[SolarSystem::kEarth]).
                 EvaluatePosition(final_time, nullptr)).
                 Norm();
    state->ResumeTiming();
  }
  state->SetLabel(DebugString(error / AstronomicalUnit) + " ua");
}

void EphemerisL4ProbeBenchmark(SolarSystem::Accuracy const accuracy,
                               not_null<benchmark::State*> const state) {
  Length sun_error;
  Length earth_error;
  int steps;

  not_null<std::unique_ptr<SolarSystem>> const at_спутник_1_launch =
      SolarSystem::AtСпутник1Launch(accuracy);
  std::vector<not_null<std::unique_ptr<MassiveBody const>>> bodies =
      at_спутник_1_launch->massive_bodies();
  std::vector<DegreesOfFreedom<ICRFJ2000Ecliptic>> const initial_state =
      at_спутник_1_launch->initial_state();

  Instant const initial_time = at_спутник_1_launch->time();
  Instant const final_time = initial_time + 100 * JulianYear;

  Ephemeris<ICRFJ2000Ecliptic>
      ephemeris(
          std::move(bodies),
          initial_state,
          at_спутник_1_launch->time(),
          McLachlanAtela1992Order5Optimal<Position<ICRFJ2000Ecliptic>>(),
          45 * Minute,
          0.1 * Milli(Metre),
          5 * Milli(Metre));

  ephemeris.Prolong(final_time);

  while (state->KeepRunning()) {
    state->PauseTiming();
    // A probe near the L4 point of the Sun-Earth system.
    MasslessBody probe;
    Trajectory<ICRFJ2000Ecliptic> trajectory(&probe);
    DegreesOfFreedom<ICRFJ2000Ecliptic> const sun_degrees_of_freedom =
        initial_state[SolarSystem::kSun];
    DegreesOfFreedom<ICRFJ2000Ecliptic> const earth_degrees_of_freedom =
        initial_state[SolarSystem::kEarth];
    Displacement<ICRFJ2000Ecliptic> const sun_earth_displacement =
        earth_degrees_of_freedom.position() -
        sun_degrees_of_freedom.position();
    Rotation<ICRFJ2000Ecliptic, ICRFJ2000Ecliptic> const l4_rotation(
        Quaternion(cos(π / 6), {0, 0, sin(π / 6)}));
    Displacement<ICRFJ2000Ecliptic> const sun_l4_displacement =
        l4_rotation(sun_earth_displacement);
    Velocity<ICRFJ2000Ecliptic> const sun_earth_velocity =
        earth_degrees_of_freedom.velocity() -
        sun_degrees_of_freedom.velocity();
    Velocity<ICRFJ2000Ecliptic> const sun_l4_velocity =
        l4_rotation(sun_earth_velocity);
    trajectory.Append(initial_time,
                      DegreesOfFreedom<ICRFJ2000Ecliptic>(
                          sun_degrees_of_freedom.position() +
                              sun_l4_displacement,
                          sun_degrees_of_freedom.velocity() + sun_l4_velocity));

    state->ResumeTiming();
    ephemeris.FlowWithAdaptiveStep(&trajectory,
                                   1 * Metre,
                                   1 * Metre / Second,
                                   DormandElMikkawyPrince1986RKN434FM<
                                       Position<ICRFJ2000Ecliptic>>(),
                                   final_time);
    state->PauseTiming();

    sun_error = (ephemeris.trajectory(ephemeris.bodies()[SolarSystem::kSun]).
                     EvaluatePosition(final_time, nullptr) -
                 trajectory.last().degrees_of_freedom().position()).
                     Norm();
    earth_error = (ephemeris.trajectory(
                       ephemeris.bodies()[SolarSystem::kEarth]).
                           EvaluatePosition(final_time, nullptr) -
                   trajectory.last().degrees_of_freedom().position()).
                       Norm();
    steps = trajectory.Times().size();
    state->ResumeTiming();
  }
  std::stringstream ss;
  ss << steps;
  state->SetLabel(ss.str() + " steps, " +
                  DebugString(sun_error / AstronomicalUnit) + " ua, " +
                  DebugString(earth_error / AstronomicalUnit) + " ua");
}

void EphemerisLEOProbeBenchmark(SolarSystem::Accuracy const accuracy,
                                not_null<benchmark::State*> const state) {
  Length sun_error;
  Length earth_error;
  int steps;

  not_null<std::unique_ptr<SolarSystem>> const at_спутник_1_launch =
      SolarSystem::AtСпутник1Launch(accuracy);
  std::vector<not_null<std::unique_ptr<MassiveBody const>>> bodies =
      at_спутник_1_launch->massive_bodies();
  std::vector<DegreesOfFreedom<ICRFJ2000Ecliptic>> const initial_state =
      at_спутник_1_launch->initial_state();

  Instant const initial_time = at_спутник_1_launch->time();
  Instant const final_time = initial_time + 1 * JulianYear;

  Ephemeris<ICRFJ2000Ecliptic>
      ephemeris(
          std::move(bodies),
          initial_state,
          at_спутник_1_launch->time(),
          McLachlanAtela1992Order5Optimal<Position<ICRFJ2000Ecliptic>>(),
          45 * Minute,
          0.1 * Milli(Metre),
          5 * Milli(Metre));

  ephemeris.Prolong(final_time);

  while (state->KeepRunning()) {
    state->PauseTiming();
    // A probe in low earth orbit.
    MasslessBody probe;
    Trajectory<ICRFJ2000Ecliptic> trajectory(&probe);
    DegreesOfFreedom<ICRFJ2000Ecliptic> const earth_degrees_of_freedom =
        initial_state[SolarSystem::kEarth];
    Displacement<ICRFJ2000Ecliptic> const earth_probe_displacement(
        {6371 * Kilo(Metre) + 100 * NauticalMile, 0 * Metre, 0 * Metre});
    Speed const earth_probe_speed =
        Sqrt(ephemeris.bodies()[SolarSystem::kEarth]->
                 gravitational_parameter() /
                 earth_probe_displacement.Norm());
    Velocity<ICRFJ2000Ecliptic> const earth_probe_velocity(
        {0 * Metre / Second, earth_probe_speed, 0 * Metre / Second});
    trajectory.Append(initial_time,
                      DegreesOfFreedom<ICRFJ2000Ecliptic>(
                          earth_degrees_of_freedom.position() +
                              earth_probe_displacement,
                          earth_degrees_of_freedom.velocity() +
                              earth_probe_velocity));

    state->ResumeTiming();
    ephemeris.FlowWithAdaptiveStep(&trajectory,
                                   1 * Metre,
                                   1 * Metre / Second,
                                   DormandElMikkawyPrince1986RKN434FM<
                                       Position<ICRFJ2000Ecliptic>>(),
                                   final_time);
    state->PauseTiming();

    sun_error = (ephemeris.trajectory(ephemeris.bodies()[SolarSystem::kSun]).
                     EvaluatePosition(final_time, nullptr) -
                 trajectory.last().degrees_of_freedom().position()).
                     Norm();
    earth_error = (ephemeris.trajectory(
                       ephemeris.bodies()[SolarSystem::kEarth]).
                           EvaluatePosition(final_time, nullptr) -
                   trajectory.last().degrees_of_freedom().position()).
                       Norm();
    steps = trajectory.Times().size();
    state->ResumeTiming();
  }
  std::stringstream ss;
  ss << steps;
  state->SetLabel(ss.str() + " steps, " +
                  DebugString(sun_error / AstronomicalUnit) + " ua, " +
                  DebugString((earth_error - 6371 * Kilo(Metre)) /
                                  NauticalMile) + " nmi");
}

}  // namespace

void BM_EphemerisSolarSystemMajorBodiesOnly(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisSolarSystemBenchmark(SolarSystem::Accuracy::kMajorBodiesOnly,
                                &state);
}

void BM_EphemerisSolarSystemMinorAndMajorBodies(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisSolarSystemBenchmark(SolarSystem::Accuracy::kMinorAndMajorBodies,
                                &state);
}

void BM_EphemerisSolarSystemAllBodiesAndOblateness(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisSolarSystemBenchmark(SolarSystem::Accuracy::kAllBodiesAndOblateness,
                                &state);
}

void BM_EphemerisL4ProbeMajorBodiesOnly(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisL4ProbeBenchmark(SolarSystem::Accuracy::kMajorBodiesOnly,
                            &state);
}

void BM_EphemerisL4ProbeMinorAndMajorBodies(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisL4ProbeBenchmark(SolarSystem::Accuracy::kMinorAndMajorBodies,
                            &state);
}

void BM_EphemerisL4ProbeAllBodiesAndOblateness(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisL4ProbeBenchmark(SolarSystem::Accuracy::kAllBodiesAndOblateness,
                            &state);
}

void BM_EphemerisLEOProbeMajorBodiesOnly(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisLEOProbeBenchmark(SolarSystem::Accuracy::kMajorBodiesOnly,
                             &state);
}

void BM_EphemerisLEOProbeMinorAndMajorBodies(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisLEOProbeBenchmark(SolarSystem::Accuracy::kMinorAndMajorBodies,
                             &state);
}

void BM_EphemerisLEOProbeAllBodiesAndOblateness(
    benchmark::State& state) {  // NOLINT(runtime/references)
  EphemerisLEOProbeBenchmark(SolarSystem::Accuracy::kAllBodiesAndOblateness,
                             &state);
}

BENCHMARK(BM_EphemerisSolarSystemMajorBodiesOnly);
BENCHMARK(BM_EphemerisSolarSystemMinorAndMajorBodies);
BENCHMARK(BM_EphemerisSolarSystemAllBodiesAndOblateness);
BENCHMARK(BM_EphemerisL4ProbeMajorBodiesOnly);
BENCHMARK(BM_EphemerisL4ProbeMinorAndMajorBodies);
BENCHMARK(BM_EphemerisL4ProbeAllBodiesAndOblateness);
BENCHMARK(BM_EphemerisLEOProbeMajorBodiesOnly);
BENCHMARK(BM_EphemerisLEOProbeMinorAndMajorBodies);
BENCHMARK(BM_EphemerisLEOProbeAllBodiesAndOblateness);

}  // namespace benchmarks
}  // namespace principia
